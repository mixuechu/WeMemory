# 权重配比评测文档

## 评测目的
在BM25和向量检索之间找到最佳权重配比，使混合检索能够"正确联想到相关信息"，而不仅仅是"找词频最接近的"。

## 评测方法

### 测试数据
- **对话**: alex_li (1,069条消息)
- **向量库**: alex_li_dual.pkl (双向量：content 85% + context 15%)

### 测试查询类型

#### 1. 有意义查询（15个）
位置: `queries/meaningful_test_queries.json`

测试查询能否找到事实性、可验证的信息，例如：
- "我跟alex聊过AI相关的话题吗"
- "关于AWS权限的讨论"
- "alex让我不要做前端"
- "galpha项目相关的讨论"
- "关于在国内开外包公司的想法"

**关键发现**：
- BM25:0.7/0.9在查询"galpha项目"和"代码仓库"时都错误返回"问点AI相关的"（完全不相关）
- BM25:0.3/0.5能正确找到相关内容

#### 2. 同义词查询（12个）
位置: `queries/synonym_test_queries.json`

测试向量检索的语义理解能力，查询使用同义词/近义词：
- "关于薪水的讨论" (数据中是：工资/报酬/钱/12000/rmb)
- "有人离职或者辞职吗" (数据中是：走了/不干了/闹着走)
- "账号的访问权限" (数据中是：权限/access/IAM/授权)
- "工作时长和工时" (数据中是：时间/8小时/每天)

**关键发现**：
- 同义词查询中BM25:0.5表现最好
- 部分同义词在数据中也高频出现，所以BM25也能匹配

### 测试的权重配比
- BM25:0.3 Vector:0.7
- BM25:0.5 Vector:0.5
- BM25:0.7 Vector:0.3
- BM25:0.9 Vector:0.1

### 评分标准
基于语义相关性的人工评分（0-10分）：
- 10分：高度相关，直接回答查询或提供关键信息
- 7-9分：相关性强，包含重要相关信息
- 4-6分：有一定相关性，但不是核心信息
- 1-3分：弱相关，仅有间接联系
- 0分：完全不相关

## 评测结果

### 有意义查询结果（15个查询）
| 权重配比 | 总分 | 平均分 |
|---------|------|--------|
| **BM25:0.3 Vector:0.7** | **134/150** | **8.93** |
| BM25:0.5 Vector:0.5 | 133/150 | 8.87 |
| BM25:0.7 Vector:0.3 | 102/150 | 6.80 |
| BM25:0.9 Vector:0.1 | 102/150 | 6.80 |

**关键案例**：
- 查询"galpha项目相关的讨论"：BM25:0.3/0.5得10分，BM25:0.7/0.9得0分（完全错误）
- 查询"我们聊过代码仓库的事"：BM25:0.3/0.5得10分，BM25:0.7/0.9得0分（完全错误）
- 查询"alex让我不要做前端"：BM25:0.3/0.5得10分，BM25:0.7/0.9得5分（找错了对话）

### 同义词查询结果（12个查询）
| 权重配比 | 总分 | 平均分 |
|---------|------|--------|
| BM25:0.3 Vector:0.7 | 76/120 | 6.33 |
| **BM25:0.5 Vector:0.5** | **83/120** | **6.92** |
| BM25:0.7 Vector:0.3 | 82/120 | 6.83 |
| BM25:0.9 Vector:0.1 | 83/120 | 6.92 |

**关键案例**：
- "有人离职或者辞职吗" → 成功找到"离职时机很棒"（所有权重都成功）
- "账号的访问权限" → 成功找到"权限""IAM""授权"（所有权重都成功）
- "工作时长和工时" → BM25:0.5+找到"每周5天全职工作"，BM25:0.3找错了

### 综合结果
| 权重配比 | 直接查询 | 同义词查询 | 综合平均 |
|---------|---------|-----------|---------|
| BM25:0.3 Vector:0.7 | 8.93 | 6.33 | 7.78 |
| **BM25:0.5 Vector:0.5** | **8.87** | **6.92** | **8.00** 🏆 |
| BM25:0.7 Vector:0.3 | 6.80 | 6.83 | 6.81 |
| BM25:0.9 Vector:0.1 | 6.80 | 6.92 | 6.85 |

## 最终结论

**推荐权重配比：BM25:0.5 Vector:0.5**

### 理由
1. **综合表现最佳**：在直接查询和同义词查询中都表现优秀（平均8.00分）
2. **平衡性好**：既能利用向量的语义理解能力，又能利用BM25的关键词匹配
3. **避免严重失败**：不像BM25:0.7/0.9那样出现完全错误的结果（0分）
4. **稳定可靠**：在各种查询类型中表现稳定

### 为什么不选BM25:0.3?
虽然BM25:0.3在有意义查询中得分最高（8.93），但在同义词查询中表现较差（6.33），综合得分7.78低于BM25:0.5的8.00。

### 为什么不选BM25:0.7/0.9?
这两个配比在有意义查询中出现了严重的语义误匹配，多次返回完全不相关的结果（0分）。过度依赖BM25会导致"找词频最接近的"而不是"正确联想相关信息"。

## 文件说明

### scripts/ - 评测脚本
- `test_with_meaningful_queries.py` - 有意义查询测试
- `test_synonym_queries.py` - 同义词查询测试
- `optimize_weights.py` - 自动化权重优化（基于分数区分度，评估方法有问题，仅供参考）

### queries/ - 测试查询
- `meaningful_test_queries.json` - 15个有意义的查询
- `synonym_test_queries.json` - 12个同义词查询

### results/ - 评测结果
- `meaningful_eval_results.json` - 有意义查询的完整结果
- `synonym_test_results.json` - 同义词查询的完整结果
- `top1_comparison.json` - 有意义查询Top-1对比（精简版）
- `synonym_top1_comparison.json` - 同义词查询Top-1对比（精简版）

## 使用方法

### 1. 运行有意义查询测试
```bash
python weight_evaluation/scripts/test_with_meaningful_queries.py
```

### 2. 运行同义词查询测试
```bash
python weight_evaluation/scripts/test_synonym_queries.py
```

### 3. 查看结果
结果保存在 `weight_evaluation/results/` 目录下的JSON文件中。

## 评测经验总结

1. **不要用无意义的查询**：像"可以"、"这个"、"━━"这种查询无法测试语义理解能力
2. **事实性查询很重要**：能验证召回结果是否真正相关
3. **同义词测试必不可少**：这是向量检索的核心优势
4. **不能只看数值指标**：分数区分度、Top1-Top3差值等指标会偏向BM25，需要人工评估语义相关性
5. **要测试失败案例**：关注什么情况下会完全错误，这比平均分更重要

## 后续优化方向

1. 可以在更多对话上测试（目前只用了alex_li一个对话）
2. 可以增加更多同义词查询类型
3. 可以测试更多权重配比（如0.4, 0.6）
4. 可以使用LLM自动评估（需要API成本）
