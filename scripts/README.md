# å¾®ä¿¡è®°å¿†ç³»ç»Ÿ - è„šæœ¬ä½¿ç”¨æŒ‡å—

æœ¬ç›®å½•åŒ…å«æ•´åˆæ‰€æœ‰æœ€ä½³å®è·µçš„æ­£å¼è„šæœ¬ã€‚

## æœ€ä½³å®è·µæ¶æ„

ç»è¿‡ä¸¤å¤©è¿­ä»£ï¼Œæˆ‘ä»¬ç¡®å®šäº†ä»¥ä¸‹æœ€ä½³å®è·µï¼š

### 1. åŒå±‚å‘é‡ (Dual-Vector)
- **Contentå‘é‡**: 85%æƒé‡ï¼Œæ•è·æ¶ˆæ¯æ ¸å¿ƒå†…å®¹
- **Contextå‘é‡**: 15%æƒé‡ï¼Œæ•è·ä¸Šä¸‹æ–‡å’Œå…ƒä¿¡æ¯
- å®ç°: `embedding/generator.py`

### 2. æ»‘åŠ¨çª—å£åˆ†ç‰‡ (Sliding Window)
- **æ—¶é—´gap**: 30åˆ†é’Ÿï¼Œè¶…è¿‡åˆ™åˆ†å‰²
- **æ¶ˆæ¯æ•°é‡**: 3-20æ¡ï¼Œå¤ªå°‘ä¸¢å¼ƒï¼Œå¤ªå¤šåˆ†å‰²
- **è¾¹ç•Œé‡å **: ç›¸é‚»ç‰‡æ®µåˆ›å»ºoverlapé¿å…ä¿¡æ¯ä¸¢å¤±
- å®ç°: `data_loader/session.py`

### 3. åŠ¨æ€Batch (Dynamic Batching)
- **é—®é¢˜**: å›ºå®šbatch_sizeä¼šå¯¼è‡´tokenè¶…é™ï¼ˆ20,000 tokens/requestï¼‰
- **è§£å†³**: åŸºäºå®é™…tokenæ•°åŠ¨æ€è°ƒæ•´batchå¤§å°
- **ä¼°ç®—**: ~1.5 tokens/å­—ç¬¦ï¼ˆä¸­æ–‡ï¼‰
- **é™åˆ¶**: å•æ–‡æœ¬2,048 tokensï¼Œå•è¯·æ±‚19,000 tokensï¼ˆç•™bufferï¼‰
- å®ç°: `embedding/generator.py::create_dynamic_batches()`

### 4. åˆ†ç‰‡ä¿å­˜ç­–ç•¥ (Shard-Based Storage)
- **é—®é¢˜**: å…¨é‡åŠ è½½å¯¼è‡´OOMï¼ˆ3.9GB RAMé™åˆ¶ï¼‰
- **è§£å†³**: æ¯ä¸ªå¯¹è¯ç‹¬ç«‹ä¿å­˜ä¸ºshardï¼Œæœ€ååˆå¹¶
- **ä¼˜åŠ¿**: å†…å­˜ç¨³å®šï¼Œæ”¯æŒå¢é‡æ›´æ–°ï¼Œå®¹é”™æ€§å¼º
- **ä¿ç•™åˆ†ç‰‡**: åˆå¹¶åä¿ç•™shardæ–‡ä»¶ï¼Œæ–¹ä¾¿è°ƒè¯•å’Œå¢é‡æ›´æ–°
- å®ç°: `scripts/generate_embeddings.py`

### 5. æ··åˆæ£€ç´¢ (Hybrid Retrieval)
- **BM25**: å…³é”®è¯åŒ¹é…ï¼Œæƒé‡0.5
- **Vector**: è¯­ä¹‰ç›¸ä¼¼åº¦ï¼Œæƒé‡0.5
- **FAISS HNSW**: å¤§è§„æ¨¡æ•°æ®ï¼ˆ>=5000ï¼‰è‡ªåŠ¨å¯ç”¨ï¼Œ100-400xåŠ é€Ÿ
- å®ç°: `retrieval/hybrid.py`

## ä½¿ç”¨æ–¹æ³•

### ç”Ÿæˆå‘é‡åº“ï¼ˆé¦–æ¬¡ï¼‰

```bash
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source venv_embedding/Scripts/activate  # Windows Git Bash
# æˆ–
source venv_embedding/bin/activate      # Linux/Mac

# ç”Ÿæˆembeddingsï¼ˆä½¿ç”¨æ‰€æœ‰æœ€ä½³å®è·µï¼‰
python scripts/generate_embeddings.py --excel èŠå¤©è®°å½•excel/messages.xlsx

# å¯é€‰å‚æ•°ï¼š
#   --output DIR          è¾“å‡ºç›®å½•ï¼ˆé»˜è®¤: vector_storesï¼‰
#   --no-dynamic-batch    ç¦ç”¨åŠ¨æ€batchï¼ˆä¸æ¨èï¼‰
#   --no-keep-shards      åˆå¹¶ååˆ é™¤åˆ†ç‰‡ï¼ˆä¸æ¨èï¼‰
```

### æµ‹è¯•æœç´¢åŠŸèƒ½

```bash
# æµ‹è¯•å‘é‡åº“å®Œæ•´æ€§å’Œæœç´¢
python scripts/test_search.py

# è‡ªå®šä¹‰å‘é‡åº“æ–‡ä»¶
python scripts/test_search.py --vector-file vector_stores/conversations.pkl
```

### å¢é‡æ›´æ–°ï¼ˆæœªæ¥ï¼‰

å¦‚æœåªæƒ³æ›´æ–°éƒ¨åˆ†å¯¹è¯ï¼š

1. ä¿ç•™ `vector_stores/shards/` ç›®å½•
2. åˆ é™¤æˆ–é‡æ–°ç”Ÿæˆç‰¹å®šshardï¼ˆå¦‚ `shard_0042.pkl`ï¼‰
3. é‡æ–°è¿è¡Œåˆå¹¶é€»è¾‘

## æ€§èƒ½æŒ‡æ ‡

åŸºäºå®é™…æµ‹è¯•ï¼ˆ698ä¸ªå¯¹è¯ï¼Œ183,287ä¸ªsessionsï¼‰ï¼š

- **ç”Ÿæˆæ—¶é—´**: ~80åˆ†é’Ÿï¼ˆä½¿ç”¨åŠ¨æ€batch + åˆ†ç‰‡ä¿å­˜ï¼‰
- **APIè°ƒç”¨**: ~1,200æ¬¡ï¼ˆbatch_size=250ï¼ŒåŠ¨æ€è°ƒæ•´ï¼‰
- **æˆåŠŸç‡**: 100%ï¼ˆåŠ¨æ€batché¿å…tokenè¶…é™ï¼‰
- **å†…å­˜å ç”¨**: ç¨³å®šåœ¨ ~1.5GBï¼ˆåˆ†ç‰‡ç­–ç•¥ï¼‰
- **æœ€ç»ˆæ–‡ä»¶**: 1.94GBï¼ˆæœªå‹ç¼©ï¼‰
- **æœç´¢é€Ÿåº¦**: <100msï¼ˆFAISS HNSWç´¢å¼•ï¼‰

## è®¾è®¡åŸåˆ™

æœ¬è„šæœ¬æ•´åˆäº†å¼€å‘è¿‡ç¨‹ä¸­è¿­ä»£å‡ºçš„æ‰€æœ‰æœ€ä½³å®è·µï¼š

| ç‰¹æ€§ | å®ç° |
|------|------|
| å†…å­˜ç®¡ç† | åˆ†ç‰‡ä¿å­˜ç­–ç•¥ï¼Œé¿å… OOM |
| API é™åˆ¶ | åŠ¨æ€ batchï¼ŒåŸºäº token æ•° |
| å®¹é”™æ€§ | ç‹¬ç«‹ä¿å­˜æ¯ä¸ªå¯¹è¯ï¼Œæ”¯æŒå¢é‡æ›´æ–° |
| å®Œæ•´æ€§ | 100% æˆåŠŸç‡ï¼Œ0 ä¸ªé›¶å‘é‡ |
| å¯ç»´æŠ¤æ€§ | æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ‰©å±• |

## ç›®å½•ç»“æ„

```
.
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ generate_embeddings.py  # ç»Ÿä¸€ç”Ÿæˆè„šæœ¬ï¼ˆæ•´åˆæ‰€æœ‰æœ€ä½³å®è·µï¼‰
â”‚   â”œâ”€â”€ test_search.py          # æµ‹è¯•è„šæœ¬
â”‚   â”œâ”€â”€ README.md               # æœ¬æ–‡ä»¶
â”œâ”€â”€ embedding/
â”‚   â”œâ”€â”€ client.py               # Google Embeddingå®¢æˆ·ç«¯ï¼ˆbatch_size=250ï¼‰
â”‚   â”œâ”€â”€ generator.py            # åŒå‘é‡ç”Ÿæˆå™¨ï¼ˆåŠ¨æ€batchï¼‰
â”‚   â””â”€â”€ enricher.py             # æ–‡æœ¬å¯ŒåŒ–
â”œâ”€â”€ retrieval/
â”‚   â”œâ”€â”€ hybrid.py               # æ··åˆæ£€ç´¢ï¼ˆBM25 + FAISSï¼‰
â”‚   â””â”€â”€ vector_store.py         # åŸºç¡€å‘é‡åº“
â”œâ”€â”€ data_loader/
â”‚   â”œâ”€â”€ session.py              # ä¼šè¯åˆ‡åˆ†å™¨ï¼ˆæ»‘åŠ¨çª—å£ï¼‰
â”‚   â””â”€â”€ models.py               # æ•°æ®æ¨¡å‹
â””â”€â”€ vector_stores/
    â”œâ”€â”€ conversations.pkl       # æœ€ç»ˆå‘é‡åº“
    â””â”€â”€ shards/                 # åˆ†ç‰‡æ–‡ä»¶ï¼ˆä¿ç•™ï¼‰
        â”œâ”€â”€ shard_0000.pkl
        â”œâ”€â”€ shard_0001.pkl
        â””â”€â”€ ...
```

## æ•…éšœæ’æŸ¥

### OOMé”™è¯¯
- âœ… ä½¿ç”¨åˆ†ç‰‡ä¿å­˜ç­–ç•¥ï¼ˆæ­£å¼è„šæœ¬å·²é›†æˆï¼‰
- âœ… åˆå¹¶æ—¶å¢é‡åŠ è½½ï¼ˆæ­£å¼è„šæœ¬å·²é›†æˆï¼‰

### Tokené™åˆ¶é”™è¯¯
- âœ… ä½¿ç”¨åŠ¨æ€batchï¼ˆæ­£å¼è„šæœ¬å·²é›†æˆï¼‰
- âœ… ä¼°ç®—tokenæ•°ï¼ˆ~1.5/å­—ç¬¦ï¼‰

### æœç´¢å¤±è´¥
- æ£€æŸ¥ `.env` æ–‡ä»¶æ˜¯å¦å­˜åœ¨
- ç¡®è®¤ Google Cloud é…ç½®æ­£ç¡®
- ä½¿ç”¨ `test_search.py` éªŒè¯

### é›¶å‘é‡
- æ£€æŸ¥APIé…é¢
- æŸ¥çœ‹ç”Ÿæˆæ—¥å¿—ä¸­çš„å¤±è´¥è®¡æ•°
- ä½¿ç”¨åŠ¨æ€batché‡æ–°ç”Ÿæˆ

## æ‰©å±•åŠŸèƒ½

å¯é€‰çš„å¢å¼ºåŠŸèƒ½ï¼š

1. ğŸ“ å¢é‡æ›´æ–°ï¼šåªé‡æ–°ç”Ÿæˆä¿®æ”¹çš„å¯¹è¯
2. ğŸ“ æ›´å¤šè¿‡æ»¤å™¨ï¼šæ ‡ç­¾ã€æƒ…æ„Ÿã€æ¶ˆæ¯ç±»å‹ç­‰
3. ğŸ“ æ‰¹é‡å¯¼å‡ºï¼šå°†æœç´¢ç»“æœå¯¼å‡ºä¸º Excel/JSON
4. ğŸ“ API æœåŠ¡ï¼šå°†æ£€ç´¢åŠŸèƒ½å°è£…ä¸º REST API
5. ğŸ“ Web ç•Œé¢ï¼šå¯è§†åŒ–æœç´¢å’Œæµè§ˆ

## æ›´æ–°æ—¥å¿—

- **2025-02-25**: æ•´åˆæ‰€æœ‰æœ€ä½³å®è·µåˆ°æ­£å¼è„šæœ¬
  - åŠ¨æ€batché›†æˆåˆ° `embedding/generator.py`
  - åˆ†ç‰‡ä¿å­˜ç­–ç•¥é›†æˆåˆ° `scripts/generate_embeddings.py`
  - åˆ›å»ºç»Ÿä¸€æµ‹è¯•è„šæœ¬ `scripts/test_search.py`
